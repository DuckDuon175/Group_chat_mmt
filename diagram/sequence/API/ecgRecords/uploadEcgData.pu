'

@startuml


skinparam style strictuml

skinparam lifelineStrategy solid

skinparam ParticipantPadding 70

skinparam BoxPadding 10

autonumber

actor User as User

box "view" #LightGoldenRodYellow

participant MeasureECGDataPage as MeasureECGDataPage

end box

box "route" #lightBlue

participant ECGRecordRoute as ECGRecordRoute

end box


box "controller" #LightGoldenRodYellow
participant ECGRecordController as ECGRecordController

end box


box "model" #lightBlue
participant ECGRecordModel as ECGRecordModel

end box


User -> MeasureECGDataPage: Request upload ECG data to server when finish measuring
activate User
activate MeasureECGDataPage

MeasureECGDataPage -> ECGRecordRoute: POST api/ecg-records/upload
activate ECGRecordRoute
note right of MeasureECGDataPage #Aqua
  * Request param:
  Content type: application/form-data
  Request content:
  - file: File
  - user_id: Interger
  - device_id: Interger
  - start_time: Data
  - stop_time: Date
  - sensor_type: String
end note


ECGRecordRoute -> ECGRecordController: uploadEcgData(req, res)
activate ECGRecordController

note right of ECGRecordRoute #Aqua
  * Request param:
  { user_id, device_id, start_time,
  stop_time, sensor_type } = req.body
  filename = req.file
end note

ECGRecordController -> ECGRecordController: Create folder to store ECG data file
ECGRecordController -> ECGRecordController: Store ECG data

ECGRecordController -> ECGRecordModel: create()
note right of ECGRecordController #Aqua
  * Request param
  user_id: req.user_id
  device_id: req.device_id
  data_directory: 
    "upload/record-data/{:device_id}/
    {:user_id-timestamp}/{:filename}"
  start_time: req.start_time
  stop_time: req.stop_time
  sensor_type: rq.sensor_type
end note

activate ECGRecordModel

ECGRecordModel --> ECGRecordController: return 

deactivate ECGRecordModel

ECGRecordController --> ECGRecordRoute: return response

deactivate ECGRecordController

alt response error
  ECGRecordRoute --> MeasureECGDataPage: return exception
  note right of MeasureECGDataPage
    status: "error"
    message: error description
  end note
else response success
  ECGRecordRoute --> MeasureECGDataPage: return response
  deactivate ECGRecordRoute

  note right of MeasureECGDataPage
    status: "success"
    data : ECGRecordModel
  end note
end
MeasureECGDataPage --> User: return response
deactivate MeasureECGDataPage
deactivate User

@enduml

